Ext.define("Stiki.view.Sidebar",{extend:"Ext.panel.Panel",alias:"widget.sidebar",collapsible:true,collapseDirection:"left",layout:"fit",initComponent:function(){Ext.define("Menu",{extend:"Ext.data.Model",fields:["Title","Link"]});Ext.applyIf(this,{items:[this.createView()]});this.addEvents("menuselect");this.callParent(arguments)},createView:function(){this.view=Ext.create("widget.dataview",{store:Ext.create("Ext.data.Store",{model:"Menu",data:this.menu}),selModel:{mode:"SINGLE",listeners:{scope:this,selectionchange:this.onSelectionChange}},listeners:{scope:this,contextmenu:this.onContextMenu,viewready:this.onViewReady},trackOver:true,cls:"feed-list",itemSelector:".feed-list-item",overItemCls:"feed-list-item-hover",tpl:'<tpl for="."><div class="feed-list-item">{Title}</div></tpl>'});return this.view},onViewReady:function(){},onContextMenu:function(a,b,c,d){var e=this.menu;d.stopEvent();e.activeFeed=a.store.getAt(b);e.showAt(d.getXY())},getSelectedItem:function(){return this.view.getSelectionModel().getSelection()[0]||false},onSelectionChange:function(){var a=this.getSelectedItem();this.menuSelected(a)},menuSelected:function(a){if(a){this.fireEvent("menuselect",this,a.get("Title"),a.get("Link"))}}});Ext.define("Stiki.view.MainPanel",{extend:"Ext.tab.Panel",alias:"widget.mainpanel",region:"center",activeTab:0,defaults:{padding:"10px"},
	initComponent:function(){
		Ext.apply(this,{ items:[{ title: 'Home', loader: { url: URLS.base + 'panel/home/dashboard', contentType: 'html', autoLoad: true } }]});
		this.callParent(arguments)
	}});Ext.define("Stiki.view.ContentTab",{extend:"Ext.container.Container",alias:"widget.contenttab",layout:"fit",url:"",base:URLS.stiki,initComponent:function(){this.tpl=new Ext.XTemplate('<iframe style="width: 100%; height: 100%; border: 0; margin:0; padding:0;" src="{base}{url}?iframe=true"></iframe>');this.callParent(arguments)},load:function(){this.update(this.tpl.apply(this))},clear:function(){this.update("")}});Ext.define("Stiki.view.Login",{extend:"Ext.container.Container",alias:"widget.loginpage",initComponent:function(){Ext.applyIf(this,{items:[{xtype:"loginwindow"}]});this.callParent(arguments)}});Ext.define("Stiki.view.LoginWindow",{extend:"Ext.window.Window",alias:"widget.loginwindow",y:106,width:300,height:220,closable:false,draggable:false,layout:"anchor",
	
	initComponent:function(){
		Ext.apply(this,{items:[{
			xtype:"form", url: URLS.base + 'panel/home/login', border:0, bodyStyle:"padding: 10px;", defaultType:"textfield",
			items:[
				{xtype:"container",html:'<div id="loginmsg" style="padding:10px 0;"><h2>Suekarea</h2><p>Masukkan username/password untuk login</p></div>'},
				{name:"username",fieldLabel:"Username",required:true},
				{name:"password",fieldLabel:"Password",inputType:"password",required:true}
			]
		}],
		buttons:[{name:"loginButton",text:"Login"}]});
	this.callParent(arguments)}});Ext.define("Stiki.controller.Home",{extend:"Ext.app.Controller",views:["Sidebar","MainPanel","Login"],loggedIn:false,init:function(){this.control({viewport:{render:this.onViewportRender},"loginwindow button[name=loginButton]":{click:this.onLoginButton},"loginwindow form field":{specialkey:this.onFieldSpecialKey},sidebar:{menuselect:this.onMenuSelect}})},onViewportRender:function(b){if(this.loggedIn){return}var c=this;var a=new Ext.data.Connection();a.on("beforerequest",function(){Ext.getBody().mask("please wait...")});
	
	a.on("requestcomplete",function(){Ext.getBody().unmask()});
	a.on("requestexception",function(){Ext.getBody().unmask()});
	a.request({
		url: URLS.base + 'panel/home/check',
		method:"POST",success:function(d,e){
			var f=Ext.JSON.decode(d.responseText);
			c.loggedIn=true;c.setViewportLayout(f.menu)},failure:function(d,e){Ext.ComponentQuery.query("loginwindow")[0].show()}})},onFieldSpecialKey:function(c,e){var d=c.up("form").getForm(),a=d.getFields(),b=null;if(e.getKey()==e.ENTER){b=a.indexOfKey(c.id);if(b!=null&&b<a.items.length-1){a.items[b].fireEvent("blur",c);a.items[b+1].focus(true,true)}else{this.onLoginButton()}}},onLoginButton:function(a,d){var c=Ext.ComponentQuery.query("loginwindow form")[0],b=this;c.submit({waitTitle:"Harap tunggu:",waitMsg:"Loading...",success:function(e,f){if(window.console){console.log(["submit response",f.result])}window.location.reload();b.loggedIn=true;b.setViewportLayout(f.result.menu)},failure:function(e,f){Ext.Msg.alert("Gagal:",f.result.text)}})},setViewportLayout:function(a){Ext.ComponentQuery.query("loginwindow")[0].destroy();Ext.ComponentQuery.query("viewport")[0].destroy();Ext.create("Ext.container.Viewport",{layout:"border",border:0,items:[{xtype:"container",region:"north",height:60,layout:"fit",html:Ext.get("header").dom.innerHTML,baseCls:"content-header"},{xtype:"mainpanel",region:"center",layout:"fit"},{xtype:"sidebar",region:"west",width:200,menu:a,title:"Navigasi"},{xtype:"container",applyTo:"footer",region:"south",height:30,layout:"fit",html:Ext.get("footer").dom.innerHTML,baseCls:"content-footer"}]})},onMenuSelect:function(a,d,c){var b=Ext.ComponentQuery.query("mainpanel")[0],e=false;b.items.each(function(f){if(f.url==c){e=f;return}});if(!e){e=Ext.create("Stiki.view.ContentTab",{url:c,title:d,closable:true});b.add(e)}b.setActiveTab(e);e.load()}});Ext.Loader.setConfig({enabled:true,paths:{"Ext.ux":URLS.ext+"/examples/ux",Ext:URLS.ext+"/src",Stiki:URLS.app}});Ext.require(["Stiki.controller.Home","Stiki.view.Sidebar","Stiki.view.MainPanel","Stiki.view.Login",]);Ext.application({name:"Stiki",appFolder:URLS.app,autoCreateViewport:false,controllers:["Home",],launch:function(){Ext.get("loading").destroy();Ext.create("Ext.container.Viewport",{layout:"border",border:0,items:[{xtype:"loginpage",region:"center"}]})}});
